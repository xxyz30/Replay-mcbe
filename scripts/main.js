import { world } from "mojang-minecraft";
import { Recorder } from "./recorder.js";
import { ReplayerManager } from "./ReplayerManager.js";
// world.events.tick.subscribe(e => {
//     for(let i of world.getPlayers()){
//         i.getTags().forEach(tag => {
//             if(tag.startsWith("req"))
//         })
//     }
// })
let rec = null;
let manager = new ReplayerManager();
let test = '{"replay":[[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,75.69367980957031],[2.291842222213745,-62,5.616933345794678,28.010852471055287,76.55987548828125],[2.291842222213745,-62,5.616933345794678,28.18664836958039,100.4661865234375],[1.9855451583862305,-61.58000183105469,5.5012922286987305,29.746821888197058,109.64761352539062],[1.7944698333740234,-61.246803283691406,5.4291510581970215,29.22492457416467,110.68704223632812],[1.5967540740966797,-60.9986686706543,5.354501247406006,28.18664836958039,110.68704223632812],[1.3929955959320068,-60.83389663696289,5.277568817138672,28.18664836958039,110.68704223632812],[1.1837382316589355,-60.75082015991211,5.198559284210205,28.356949360291367,110.68707275390625],[0.9694769382476807,-60.747802734375,5.117659568786621,28.532748288715112,110.68707275390625],[0.7506619691848755,-60.823246002197266,5.03503942489624,28.532748288715112,110.68707275390625],[0.5277032256126404,-60.975582122802734,4.9508538246154785,28.532748288715112,110.68707275390625],[0.3009735941886902,-61.203269958496094,4.865243911743164,28.532748288715112,110.68707275390625],[0.07081245630979538,-61.50480651855469,4.778337478637695,28.532748288715112,110.68707275390625],[-0.16247132420539856,-61.87871170043945,4.69025182723999,28.532748288715112,110.68707275390625],[-0.39859670400619507,-62,4.601092338562012,28.532748288715112,110.68707275390625],[-0.9161273241043091,-61.58000183105469,4.3950982093811035,28.532748288715112,110.68707275390625],[-1.2214521169662476,-61.246803283691406,4.2711567878723145,28.532748288715112,112.41937255859375],[-1.5210798978805542,-60.9986686706543,4.145150184631348,29.22492457416467,116.750244140625],[-1.815029501914978,-60.83389663696289,4.016482830047607,30.955427500913487,121.25430297851562],[-2.1034669876098633,-60.75082015991211,3.884883403778076,32.69142301962772,123.33306884765625],[-2.386162281036377,-60.747802734375,3.749619960784912,33.55940358264462,124.718994140625],[-2.6633477210998535,-60.823246002197266,3.6106576919555664,33.90550470904382,127.49078369140625],[-2.935422420501709,-60.975582122802734,3.468209743499756,34.76801661850896,128.5301513671875],[-3.2008273601531982,-61,3.3203673362731934,34.9438129844314,128.87664794921875],[-3.4975099563598633,-61,3.070992946624756,35.11411694601835,135.63275146484375],[-3.6181252002716064,-60.58000183105469,2.6100592613220215,36.157919966059936,154.342041015625],[-3.6798479557037354,-60.246803283691406,2.333247184753418,37.542313672936,-172.74346923828125],[-3.7318825721740723,-59.9986686706543,2.0562052726745605,39.79507637835938,-170.66465759277344],[-3.7751007080078125,-59.83389663696289,1.7789545059204102,40.31155898066865,-170.66465759277344],[-3.810296058654785,-59.75082015991211,1.5015137195587158,40.31155898066865,-170.66465759277344],[-3.8381905555725098,-59.747802734375,1.223900318145752,40.31155898066865,-170.66465759277344],[-3.8594417572021484,-59.823246002197266,0.9461293816566467,40.31155898066865,-170.66465759277344],[-3.8746471405029297,-59.975582122802734,0.6682153344154358,40.31155898066865,-170.66465759277344],[-3.8843507766723633,-60.203269958496094,0.39017099142074585,40.31155898066865,-170.66465759277344],[-3.889047622680664,-60.50480651855469,0.11200809478759766,40.31155898066865,-170.66465759277344],[-3.889188766479492,-60.87871170043945,-0.166262686252594,40.31155898066865,-170.66465759277344],[-3.885183811187744,-61,-0.4446316361427307,40.31155898066865,-170.66465759277344],[-3.828420639038086,-60.58000183105469,-1.0210094451904297,40.31155898066865,-170.66465759277344],[-3.793294906616211,-60.246803283691406,-1.3608543872833252,40.31155898066865,-170.66465759277344],[-3.757197380065918,-59.9986686706543,-1.6952558755874634,40.31155898066865,-170.66465759277344],[-3.720215320587158,-59.83389663696289,-2.0247037410736084,40.31155898066865,-170.66465759277344],[-3.6824283599853516,-59.75082015991211,-2.3496439456939697,40.31155898066865,-170.66465759277344],[-3.643908977508545,-59.747802734375,-2.6704819202423096,40.31155898066865,-170.66465759277344],[-3.6047234535217285,-59.823246002197266,-2.9875872135162354,40.31155898066865,-170.66465759277344],[-3.5649313926696777,-59.975582122802734,-3.301295518875122,40.31155898066865,-170.66465759277344],[-3.5245871543884277,-60.203269958496094,-3.611912727355957,40.31155898066865,-170.66465759277344],[-3.48374080657959,-60.50480651855469,-3.9197168350219727,40.31155898066865,-170.66465759277344],[-3.4425134658813477,-60.87871170043945,-4.224973678588867,40.31155898066865,-170.66465759277344],[-3.405775547027588,-61,-4.528225421905518,40.31155898066865,-170.837890625],[-3.4315271377563477,-60.58000183105469,-5.126191139221191,40.31155002348849,178.24835205078125],[-3.453622341156006,-60.246803283691406,-5.476860046386719,38.41031766919294,169.58663940429688],[-3.482056140899658,-59.9986686706543,-5.82004976272583,36.50402598165756,161.61785888671875],[-3.5162582397460938,-59.83389663696289,-6.156433582305908,34.42191255386589,160.9249267578125],[-3.555708885192871,-59.75082015991211,-6.486623764038086,34.25160785734995,160.9249267578125],[-3.6002988815307617,-59.747802734375,-6.811048984527588,34.25160785734995,160.9249267578125],[-3.6559958457946777,-59.823246002197266,-7.1267852783203125,34.25160785734995,160.05877685546875],[-3.7308034896850586,-59.975582122802734,-7.422308444976807,34.25161198897622,143.60150146484375],[-3.823861598968506,-60,-7.69624137878418,34.25160785734995,108.78143310546875],[-4.033824920654297,-60,-7.968663215637207,30.95542351861042,101.3323974609375],[-4.470946311950684,-59.58000183105469,-8.173943519592285,29.746821888197058,100.46621704101562],[-4.734711647033691,-59.246803283691406,-8.290428161621094,29.571026208376416,99.94650268554688],[-4.999835014343262,-58.9986686706543,-8.400829315185547,29.571026208376416,99.94650268554688],[-5.2661943435668945,-58.83389663696289,-8.505697250366211,29.571026208376416,99.94650268554688],[-5.508581161499023,-58.75082015991211,-8.601125717163086,29.571026208376416,99.94650268554688],[-5.729152679443359,-58.747802734375,-8.687965393066406,29.571026208376416,99.94650268554688],[-5.929873466491699,-58.823246002197266,-8.766990661621094,29.571026208376416,99.94650268554688],[-6.112529754638672,-58.975582122802734,-8.838903427124023,29.571026208376416,99.94650268554688],[-6.278746604919434,-59.203269958496094,-8.904342651367188,29.571026208376416,99.94650268554688],[-6.430003643035889,-59.50480651855469,-8.96389389038086,29.571026208376416,99.94650268554688],[-6.567647933959961,-59.87871170043945,-9.018083572387695,29.571026208376416,99.94650268554688],[-6.692903995513916,-60,-9.067398071289062,29.571026208376416,99.94650268554688],[-6.806887149810791,-60,-9.112274169921875,29.571026208376416,99.94650268554688],[-6.86912202835083,-60,-9.136775970458984,29.571026208376416,99.94650268554688],[-6.903102397918701,-60,-9.150154113769531,29.571026208376416,99.94650268554688],[-6.921655654907227,-60,-9.15745735168457,29.571026208376416,99.94650268554688],[-6.931785583496094,-60,-9.161445617675781,29.571026208376416,99.94650268554688],[-6.937316417694092,-60,-9.163623809814453,29.571026208376416,99.94650268554688],[-6.940336227416992,-60,-9.164812088012695,29.571026208376416,99.94650268554688],[-6.941985130310059,-60,-9.165462493896484,29.571026208376416,99.94650268554688],[-6.942885398864746,-60,-9.165817260742188,29.571026208376416,99.94650268554688],[-6.9433770179748535,-60,-9.166009902954102,29.571026208376416,99.94650268554688],[-6.943645477294922,-60,-9.166116714477539,29.571026208376416,99.94650268554688],[-6.94379186630249,-60,-9.166173934936523,29.571026208376416,99.94650268554688],[-6.943871974945068,-60,-9.166204452514648,29.571026208376416,99.94650268554688],[-6.943915843963623,-60,-9.166221618652344,29.571026208376416,99.94650268554688],[-6.943939685821533,-60,-9.166231155395508,29.571026208376416,99.94650268554688],[-6.943952560424805,-60,-9.166236877441406,29.571026208376416,99.94650268554688],[-6.943959712982178,-60,-9.166238784790039,29.571026208376416,99.94650268554688],[-6.943963527679443,-60,-9.166240692138672,29.571026208376416,99.94650268554688],[-6.943965435028076,-60,-9.166242599487305,29.571026208376416,99.94650268554688],[-6.943966388702393,-60,-9.166242599487305,29.571026208376416,99.94650268554688],[-6.943966865539551,-60,-9.166242599487305,29.571026208376416,99.94650268554688],[-6.943967342376709,-60,-9.166242599487305,29.571026208376416,99.94650268554688],[-6.943967342376709,-60,-9.166242599487305,29.571026208376416,99.94650268554688],[-6.943967342376709,-60,-9.166242599487305,29.571026208376416,99.94650268554688],[-6.943967342376709,-60,-9.166242599487305,29.571026208376416,99.94650268554688],[-6.943967342376709,-60,-9.166242599487305,29.571026208376416,99.94650268554688],[-6.943967342376709,-60,-9.166242599487305,29.571026208376416,99.94650268554688],[-6.943967342376709,-60,-9.166242599487305,29.571026208376416,99.94650268554688],[-6.943967342376709,-60,-9.166242599487305,29.571026208376416,99.94650268554688]],"name":"a"}';
manager.addReplay(test);
world.events.beforeChat.subscribe(e => {
    let strs = e.message.split(" ");
    if (strs.length > 1) {
        switch (strs[0]) {
            case 'start':
                if (rec != null)
                    return;
                //录制开始
                rec = new Recorder(e.sender);
                rec.start(strs[1]);
                e.sender.runCommand("say 录制开始");
                break;
            case 'end':
                //录制结束
                let r = rec.end();
                console.log(JSON.stringify(r));
                manager.addReplay(r);
                rec = null;
                e.sender.runCommand("say 录制结束");
                break;
            case 'play':
                manager.play(strs[1], e.sender, () => {
                    console.error("执行了");
                    try {
                        console.error(e);
                        console.error(e.sender);
                        e.sender.kill();
                        e.sender.runCommand("say 完成");
                        console.error("执行完毕");
                    }
                    catch (error) {
                        console.error(error);
                    }
                });
        }
    }
});
